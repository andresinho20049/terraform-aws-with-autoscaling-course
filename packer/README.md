# Packer - AMI Management

This directory contains all of the Packer settings and configurations for creating custom Amazon Machine Images (AMIs) for this project. The goal is to create "pre-baked" AMIs with the necessary software already installed, ensuring faster and more consistent builds for your EC2 instances, as well as reducing dependencies on external connectivity during instance boot.

## 1. Directory Structure
```
packer/
├── README.md
├── envs/
│   ├── dev/
│   │   └── dev.pkrvars.hcl
│   ├── prod/
│   │   └── prod.pkrvars.hcl
│   └── staging/
│       └── staging.pkrvars.hcl
│
├── ami-templates/          
│   └── nginx-webserver/    
│       ├── build.pkr.hcl     # Defines the provisioners (what will be installed/configured).
│       ├── source.pkr.hcl    # Defines the builder (base AMI, region, instance type, etc.).
│       └── variables.pkr.hcl # Variables specific to this AMI template.
│       └── scripts/          # Local scripts that are copied/executed by provisioners.
│           └── install_nginx.sh
│
└── output_ami_ids.tfvars
```

## 2. Prerequisites

To work with Packer in this project, you will need to have the following installed and configured on your machine:

* **Packer CLI:** Install Packer v1.8.0 or higher (or the version specified in `packer {}` in the templates).
* **AWS CLI:** Configure your AWS credentials (access key ID, secret access key, and default region) using `aws configure`. * **IAM Permissions:** The IAM user or role that Packer uses needs permissions to:
    * `ec2:RunInstances`, `ec2:TerminateInstances`, `ec2:CreateImage`, `ec2:DeregisterImage`, `ec2:DeleteSnapshot`, `ec2:CreateSnapshot`, `ec2:DescribeImages`, `ec2:DescribeInstances`, `ec2:DescribeSnapshots`, `ec2:DescribeSecurityGroups`, `ec2:CreateSecurityGroup`, `ec2:AuthorizeSecurityGroupIngress`, `ec2:RevokeSecurityGroupIngress`, `ec2:DeleteSecurityGroup`.
    * `iam:PassRole` (if the Packer Launch Template uses an instance profile).

## 3. How to Build an AMI

Follow the steps below to build an AMI for a specific environment.

**3.1. Navigate to the AMI Template Directory:**

First, navigate to the template directory of the AMI you want to build. For example, for the Nginx AMI:

```bash
cd packer/ami-templates/nginx-webserver/
```

**3.2. Initialize Packer:**

Run this command once to download the necessary Packer plugins:

```bash
packer init .
```

**3.3. Validate the Template (Optional, but Recommended):**

Verify that your template syntax is correct:

```bash
packer validate -var-file="../../envs/$ENVIRONMENT/$ENVIRONMENT.pkrvars.hcl" .
```

**3.4. Build the AMI for a Specific Environment:**

Use the `-var-file` argument to load the correct environment variables.

```bash
packer build -var-file="../../envs/$ENVIRONMENT/$ENVIRONMENT.pkrvars.hcl" .
```

Upon successful execution, Packer will print the ID of the newly created AMI to the console.

## 4. AMI Naming Convention

AMIs created by this project follow the naming convention:

`[ami_name_base_prefix]-[environment]-[YYYYMMDDHHMM]`

* `ami_name_base_prefix`: Defined in `variables.pkr.hcl` (e.g. `nginx-webserver-amzn2`).
* `environment`: The environment for which the AMI was built (e.g. `dev`, `prod`, `staging`).
* `YYYYMMDDHHMM`: Timestamp (year, month, day, hour, minute) of the AMI creation, ensuring uniqueness.

Example: `nginx-webserver-amzn2-dev-202506092230`

## 5. Terraform Integration

After a successful AMI build, the `ami_id` generated by Packer will be consumed by the Terraform configuration.

Best practice is for your Terraform to use a `data "aws_ami"` block to fetch the latest AMI based on its name and environment tags, ensuring that the infrastructure always deploys the most current version of your application.

Example of how Terraform might fetch the AMI:

```hcl
data "aws_ami" "nginx_webserver" {
  most_recent = true
  owners      = ["self"] # Busca AMIs criadas na sua própria conta

  filter {
    name   = "name"
    # O nome da AMI que você busca
    values = ["${var.ami_name_base_prefix_terraform}-${var.environment}-*"]
  }

  tags = {
    ManagedBy   = "Packer"
    Environment = var.environment # Filtra também pela tag de ambiente
  }
}

# Em seguida, você passaria este ID para o seu Launch Template/ASG:
module "web_alb" {
  source = "./modules/alb"
  # ...
  ami_id = data.aws_ami.nginx_webserver.id
  # ...
}
```

## 6. Considerations and Best Practices
* **Costs:** Packer will launch a temporary EC2 instance (using the defined `instance_type`, such as `t2.micro`) during the build process. This instance is automatically terminated after the AMI is created. Make sure that the instance types you choose for the build are eligible for the Free Tier, if applicable.
* **Security:** Ensure that the AWS credentials used by Packer (IAM User/Role) have only the minimum permissions required to perform the AMI build process.
* **Rebuilding AMIs:** Rebuild your AMIs regularly to include OS security updates and software patches.
* **Versioning:** The timestamp in the AMI name serves as a basic versioning. For more robust versioning, consider using custom tags or CI/CD tools that manage version numbers. * **Debugging:** If a Packer build fails, the temporary instance may not shut down immediately, allowing you to SSH into it to debug the issue. Check the Packer logs for the temporary instance ID.